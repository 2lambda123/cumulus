<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Terraform Best Practices · Cumulus Documentation</title><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta name="generator" content="Docusaurus"/><meta name="description" content="## How to Manage the Terraform State Bucket"/><meta name="docsearch:version" content="v13.2.0"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Terraform Best Practices · Cumulus Documentation"/><meta property="og:type" content="website"/><meta property="og:url" content="https://nasa.github.io/cumulus/"/><meta property="og:description" content="## How to Manage the Terraform State Bucket"/><meta name="twitter:card" content="summary"/><link rel="shortcut icon" href="/cumulus/undefined"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script src="https://unpkg.com/vanilla-back-to-top@7.1.14/dist/vanilla-back-to-top.min.js"></script><script>
        document.addEventListener('DOMContentLoaded', function() {
          addBackToTop(
            {"zIndex":100,"backgroundColor":"#2276AC"}
          )
        });
        </script><script src="/cumulus/js/scrollSpy.js"></script><link rel="stylesheet" href="/cumulus/css/main.css"/><script src="/cumulus/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/cumulus/"><h2 class="headerTitle">Cumulus Documentation</h2></a><a href="/cumulus/versions"><h3>v13.2.0</h3></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class=""><a href="https://nasa.github.io/cumulus-api" target="_self">API Docs</a></li><li class=""><a href="https://nasa.github.io/cumulus-distribution-api" target="_self">Distribution API Docs</a></li><li class="siteNavGroupActive"><a href="/cumulus/docs/v13.2.0/cumulus-docs-readme" target="_self">Developer Docs</a></li><li class=""><a href="/cumulus/docs/v13.2.0/data-cookbooks/about-cookbooks" target="_self">Data-Cookbooks</a></li><li class=""><a href="/cumulus/docs/v13.2.0/operator-docs/about-operator-docs" target="_self">Operator Docs</a></li><li class="navSearchWrapper reactNavSearchWrapper"><input type="text" id="search_input_react" placeholder="Search" title="Search"/></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>Deployment</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Getting Started<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/cumulus/docs/v13.2.0/cumulus-docs-readme">Introduction</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v13.2.0/getting-started">Getting Started</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v13.2.0/glossary">Glossary</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v13.2.0/faqs">Frequently Asked Questions</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">About Cumulus<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/cumulus/docs/v13.2.0/architecture">Architecture</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v13.2.0/interfaces">Interfaces</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v13.2.0/team">Cumulus Team</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Overviews<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/cumulus/docs/v13.2.0/workflows/workflows-readme">Workflows</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v13.2.0/workflows/protocol">Workflow Protocol</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v13.2.0/workflows/input_output">Workflow Inputs &amp; Outputs</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v13.2.0/workflows/cumulus-task-message-flow">Cumulus Tasks: Message Flow</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v13.2.0/workflows/workflow-triggers">Workflow Triggers</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Deployment<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/cumulus/docs/v13.2.0/deployment/deployment-readme">How to Deploy Cumulus</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v13.2.0/deployment/create_bucket">Creating an S3 Bucket</a></li><li class="navListItem navListItemActive"><a class="navItem" href="/cumulus/docs/v13.2.0/deployment/terraform-best-practices">Terraform Best Practices</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v13.2.0/deployment/choosing_configuring_rds">Choosing and configuration your RDS database</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v13.2.0/deployment/postgres_database_deployment">PostgreSQL Database Deployment</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v13.2.0/deployment/components">Component-based Cumulus Deployment</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v13.2.0/deployment/thin_egress_app">Using the Thin Egress App for Cumulus distribution</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v13.2.0/deployment/cumulus_distribution">Using the Cumulus Distribution API</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v13.2.0/deployment/api-gateway-logging">API Gateway Logging</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v13.2.0/deployment/share-s3-access-logs">Share S3 Access Logs</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v13.2.0/deployment/cloudwatch-logs-delivery">Configure Cloudwatch Logs Delivery</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v13.2.0/deployment/upgrade-readme">Upgrading Cumulus</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Configuration<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/cumulus/docs/v13.2.0/configuration/monitoring-readme">Monitoring Best Practices</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v13.2.0/configuration/server_access_logging">S3 Server Access Logging</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v13.2.0/configuration/cloudwatch-retention">Cloudwatch Retention</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v13.2.0/configuration/lifecycle-policies">Setting S3 Lifecycle Policies</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v13.2.0/configuration/collection-storage-best-practices">Collection Cost Tracking and Storage Best Practices</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v13.2.0/configuration/task-configuration">Configuration of Tasks</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Development<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/cumulus/docs/v13.2.0/workflows/developing-a-cumulus-workflow">Creating a Cumulus Workflow</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v13.2.0/workflows/developing-workflow-tasks">Developing Workflow Tasks</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v13.2.0/workflows/lambda">Develop Lambda Functions</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v13.2.0/workflows/docker">Dockerizing Data Processing</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v13.2.0/workflows/workflow-configuration-how-to">Workflow Configuration How To&#x27;s</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Workflow Tasks<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/cumulus/docs/v13.2.0/tasks">Cumulus Tasks</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v13.2.0/workflow_tasks/discover_granules">Discover Granules</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v13.2.0/workflow_tasks/files_to_granules">Files To Granules</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v13.2.0/workflow_tasks/lzards_backup">LZARDS Backup</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v13.2.0/workflow_tasks/move_granules">Move Granules</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v13.2.0/workflow_tasks/parse_pdr">Parse PDR</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v13.2.0/workflow_tasks/queue_granules">Queue Granules</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Features<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/cumulus/docs/v13.2.0/features/backup_and_restore">Cumulus Backup and Restore</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v13.2.0/features/dead_letter_queues">Dead Letter Queues</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v13.2.0/features/ems_reporting">EMS Reporting</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v13.2.0/features/execution_payload_retention">Execution Payload Retention</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v13.2.0/features/reports">Reconciliation Reports</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v13.2.0/features/lambda_versioning">Lambda Versioning</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v13.2.0/features/ancillary_metadata">Ancillary Metadata Export</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v13.2.0/features/distribution-metrics">Cumulus Distribution Metrics</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v13.2.0/features/logging-esdis-metrics">Writing logs for ESDIS Metrics</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Troubleshooting<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/cumulus/docs/v13.2.0/troubleshooting/troubleshooting-readme">How to Troubleshoot and Fix Issues</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v13.2.0/troubleshooting/troubleshooting-deployment">Troubleshooting Deployment</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v13.2.0/troubleshooting/reindex-elasticsearch">Reindexing Elasticsearch Guide</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Cumulus Development<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/cumulus/docs/v13.2.0/adding-a-task">Contributing a Task</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v13.2.0/docs-how-to">Cumulus Documentation: How To&#x27;s</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Integrator Guide<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/cumulus/docs/v13.2.0/integrator-guide/about-int-guide">About Integrator Guide</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v13.2.0/integrator-guide/int-common-use-cases">Integrator Common Use Cases</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v13.2.0/integrator-guide/workflow-add-new-lambda">Workflow - Add New Lambda</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v13.2.0/integrator-guide/workflow-ts-failed-step">Workflow - Troubleshoot Failed Step(s)</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Upgrade Notes<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/cumulus/docs/v13.2.0/upgrade-notes/migrate_tea_standalone">Migrate TEA deployment to standalone module</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v13.2.0/upgrade-notes/upgrade_tf_version_0.13.6">Upgrade to TF version 0.13.6</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v13.2.0/upgrade-notes/upgrade-rds">Upgrade to RDS release</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v13.2.0/upgrade-notes/cumulus_distribution_migration">Migrate from TEA deployment to Cumulus Distribution</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v13.2.0/upgrade-notes/update-task-file-schemas">Updates to task granule file schemas</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v13.2.0/upgrade-notes/update-cma-2.0.2">Upgrade to CMA 2.0.2</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">External Contributions<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/cumulus/docs/v13.2.0/external-contributions/external-contributions">External Contributions</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              var headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                var el = event.target;
                while(el !== headings){
                  if (el.tagName === 'A') {
                    document.body.classList.remove('tocActive');
                    break;
                  } else{
                    el = el.parentNode;
                  }
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer docsContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1 id="__docusaurus" class="postHeaderTitle">Terraform Best Practices</h1></header><article><div><span><h2><a class="anchor" aria-hidden="true" id="how-to-manage-the-terraform-state-bucket"></a><a href="#how-to-manage-the-terraform-state-bucket" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>How to Manage the Terraform State Bucket</h2>
<h3><a class="anchor" aria-hidden="true" id="enable-bucket-versioning"></a><a href="#enable-bucket-versioning" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Enable Bucket Versioning</h3>
<p>Since the Terraform state file for your Cumulus deployment is stored in S3, in
order to guard against its corruption or loss, it is <strong>strongly recommended</strong>
that versioning is enabled on the S3 bucket used for persisting your
deployment's Terraform state file.</p>
<p>To enable bucket versioning, either use the AWS CLI command given in
<a href="README.md#configuring-the-cumulus-deployment">Configuring the Cumulus deployment</a>, or the AWS Management Console, as follows:</p>
<ol>
<li>Go to the S3 service</li>
<li>Go to the bucket used for storing Terraform state files</li>
<li>Click the <strong>Properties</strong> tab</li>
<li>If the <strong>Versioning</strong> property is disabled, click <strong>Disabled</strong> to enable it,
which should then show the property as <strong>Enabled</strong>, with a check mark next
to it.</li>
</ol>
<h4><a class="anchor" aria-hidden="true" id="how-to-recover-from-a-corrupted-state-file"></a><a href="#how-to-recover-from-a-corrupted-state-file" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>How to Recover from a Corrupted State File</h4>
<p>If your state file appears to be corrupted, or in some invalid state, and the
containing bucket has bucket versioning enabled, you may be able to recover by
<a href="https://docs.aws.amazon.com/AmazonS3/latest/dev/RestoringPreviousVersions.html">restoring a previous version</a> of the state file. There are two primary
approaches, but the AWS documentation does not provide specific instructions
for either one:</p>
<ul>
<li><strong>Option 1:</strong> Copy a previous version of the state file into the same bucket</li>
<li><strong>Option 2:</strong> Permanently delete the current version of the file (i.e., the
corrupted one)</li>
</ul>
<p>For either approach, when using the <strong>AWS Management Console</strong>, the first steps
are:</p>
<ol>
<li>Go to the S3 service</li>
<li>Go to the appropriate bucket</li>
<li>On the <strong>Overview</strong> tab for the bucket, click the <strong>Show</strong> button to show
object versions</li>
<li>Locate your state file</li>
</ol>
<p>To <strong>copy a previous version of your state file into the same bucket</strong>:</p>
<ol>
<li>Select the desired (good) version of the state file that you wish to make
the latest version</li>
<li>Click the <strong>Download</strong> button</li>
<li>Choose the location where you wish to save the file</li>
<li><strong>IMPORTANT:</strong> Ensure the file name is identical to the name of the state
file in the bucket</li>
<li>Click <strong>Save</strong></li>
<li>Now click the <strong>Upload</strong> button</li>
<li>Click the <strong>Add files</strong> button</li>
<li>Choose the file you just downloaded and click <strong>Open</strong></li>
<li>Click the <strong>Next</strong> button (multiple times), then click the <strong>Upload</strong> button</li>
</ol>
<p>Once the upload completes, the newly uploaded file (identical to the good
version you just downloaded) becomes the <strong>Latest version</strong> of the state file.</p>
<p><strong>Alternatively,</strong> if you simply wish to delete the latest (corrupted) version
of the state file:</p>
<ol>
<li>Click the latest version of the file (listed at the top)</li>
<li>Click the <strong>Actions</strong> button and select <strong>Delete</strong></li>
<li>On the dialog window, click the <strong>Delete</strong> button</li>
</ol>
<p>At this point, the previous version is now the latest version.</p>
<p><strong>NOTE:</strong> When attempting to delete the latest (corrupt) version of the file,
you must <em>explicitly</em> choose the latest version. Otherwise, if you simply
choose the file when versions are hidden, deleting it will insert a
<em>delete marker</em> as the latest version of the file. This means that all prior
versions still exist, but the file <em>appears</em> to be deleted. When you <strong>Show</strong>
the versions, you will see all of the previous versions (including the corrupt
one), as well as a <em>delete marker</em> as the current version.</p>
<h4><a class="anchor" aria-hidden="true" id="how-to-recover-from-a-deleted-state-file"></a><a href="#how-to-recover-from-a-deleted-state-file" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>How to Recover from a Deleted State File</h4>
<p>If your state file appears to be deleted, but the containing bucket has bucket
versioning enabled, you <em>might</em> be able to recover the file. This can occur
when your state file is not <em>permanently</em> deleted, but rather a <em>delete marker</em>
is the latest version of your file, and thus the file <em>appears</em> to be deleted.</p>
<p>To recover your deleted state file via the <strong>AWS Management Console, you may
follow one of the options detailed in the previous section</strong> because the
<em>delete marker</em> is simply considered the latest version of your file, and thus
can be treated in the same manner as any other version of your file.</p>
<p>To handle this via the <strong>AWS CLI</strong> instead, first obtain the version ID of the
delete marker by replacing <code>BUCKET</code> and <code>KEY</code> as appropriate for the state file
in question, in the following command:</p>
<pre><code class="hljs css language-bash">aws s3api list-object-versions \
  --bucket BUCKET \
  --prefix KEY \
  --query <span class="hljs-string">"DeleteMarkers[?IsLatest].VersionId | [0]"</span>
</code></pre>
<p>If the output from this command is <code>null</code>, then there is no delete marker, and
you may want to double-check your bucket and key values. If the bucket and key
values are correct, then your state file is either <em>not</em> marked as deleted or
does not exist at all.</p>
<p>Otherwise, you may remove the delete marker so that the state file no longer
appears deleted. This will restore the previous version of the file and make it
the latest version. Run the following command, using the same values for
<code>BUCKET</code> and <code>KEY</code> as used in the previous command, and replacing <code>VERSION_ID</code>
with the value output from the previous command:</p>
<pre><code class="hljs css language-bash">aws s3api delete-object \
  --bucket BUCKET \
  --key KEY \
  --version-id VERSION_ID
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="deny-deletebucket-action"></a><a href="#deny-deletebucket-action" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Deny DeleteBucket Action</h3>
<p>As an additional measure to protect your Terraform state files from accidental
loss, it is also recommended that you deny all users the ability to delete the
bucket itself. At a later time, you may remove this protection when you are
sure you want to delete the bucket.</p>
<p>To perform this action via the <strong>AWS Management Console</strong>:</p>
<ol>
<li><p>Go to the S3 service</p></li>
<li><p>Go to the bucket used for storing state files</p></li>
<li><p>Click the <strong>Permissions</strong> tab</p></li>
<li><p>Click <strong>Bucket Policy</strong></p></li>
<li><p>Add the following policy statement to <em>deny</em> the <code>s3:DeleteBucket</code> action for
all (<code>&quot;*&quot;</code>) principals, replacing <code>BUCKET_NAME</code> with the name of the bucket:</p>
<pre><code class="hljs css language-json">{
  <span class="hljs-attr">"Statement"</span>: [
    {
      <span class="hljs-attr">"Sid"</span>: <span class="hljs-string">"DenyDeleteBucket"</span>,
      <span class="hljs-attr">"Effect"</span>: <span class="hljs-string">"Deny"</span>,
      <span class="hljs-attr">"Principal"</span>: <span class="hljs-string">"*"</span>,
      <span class="hljs-attr">"Action"</span>: <span class="hljs-string">"s3:DeleteBucket"</span>,
      <span class="hljs-attr">"Resource"</span>: <span class="hljs-string">"arn:aws:s3:::BUCKET_NAME"</span>
    }
  ]
}
</code></pre></li>
<li><p>Click <strong>Save</strong></p></li>
</ol>
<p>To perform this action via the <strong>AWS CLI</strong> instead, save the JSON shown above
to a file named <code>policy.json</code> and run the following command from the directory
in which you saved <code>policy.json</code>, replacing <code>BUCKET_NAME</code> with the name of the
bucket:</p>
<pre><code class="hljs css language-bash">aws s3api put-bucket-policy --policy file://policy.json --bucket BUCKET_NAME
</code></pre>
<p>Afterwards, remove the <code>policy.json</code> file.</p>
<h2><a class="anchor" aria-hidden="true" id="change-resources-only-via-terraform"></a><a href="#change-resources-only-via-terraform" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Change Resources Only via Terraform</h2>
<p><strong>All resource changes must be made via Terraform</strong>, otherwise you risk that
your Terraform state file does not correctly represent the state of your
deployment resources. Specifically, this means:</p>
<ul>
<li><strong>DO NOT</strong> change deployment resources via the AWS Management Console</li>
<li><strong>DO NOT</strong> change deployment resources via the AWS CLI</li>
<li><strong>DO NOT</strong> change deployment resources via any of the AWS SDKs</li>
</ul>
<p>Instead, <strong>DO</strong> change deployment resources <strong>only</strong> via changes to your
Terraform files (along with subsequent Terraform commands), except where
specifically instructed otherwise (such as in the instructions for destroying
a deployment).</p>
<h3><a class="anchor" aria-hidden="true" id="avoid-changing-connectivity-resources"></a><a href="#avoid-changing-connectivity-resources" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Avoid Changing Connectivity Resources</h3>
<p>Keep in mind that changing connectivity resources can affect your ingest
functionality and API availability.</p>
<p>Only update connectivity resources such as your VPC, subnets, and security
groups through Terraform deployments with S3 bucket versioning enabled. Test
connectivity immediately following deployment.</p>
<h3><a class="anchor" aria-hidden="true" id="how-to-reconcile-differences"></a><a href="#how-to-reconcile-differences" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>How to Reconcile Differences</h3>
<p>If your state file should get out of synch with the true state of your
resources, there are a number of things you can attempt to reconcile the
differences. However, given that each Cumulus deployment is unique, we can
provide only general guidance:</p>
<ul>
<li>Consider restoring a previous version of your state file, as described
in the earlier section about recovering from a corrupted state file</li>
<li>If resources exist, but are not listed in your state file, consider using
<code>terraform import</code> (see <a href="https://www.terraform.io/docs/import/index.html">https://www.terraform.io/docs/import/index.html</a>)</li>
<li>If resources are missing, but are listed in your state file, run
<code>terraform plan</code> or <code>terraform apply</code>, both of which automatically run
<code>terraform refresh</code> to reconcile state. You may also run <code>terraform refresh</code>
directly.</li>
</ul>
<h2><a class="anchor" aria-hidden="true" id="how-to-destroy-everything"></a><a href="#how-to-destroy-everything" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>How to Destroy Everything</h2>
<p>If you want to completely remove a deployment, note that there is some
protection in place to prevent accidental destruction of your data.  Therefore,
there is an additional step required when you truly want to remove your entire
deployment. Further, destruction is performed in reverse order of creation.</p>
<p>Starting from the root of your deployment repository workspace, perform the
following commands to first <strong>destroy the resources for your <code>cumulus</code> module</strong>
deployment.</p>
<p><strong>NOTE:</strong> If you are using Terraform workspaces, be sure to select the relevant
workspace first.</p>
<pre><code class="hljs css language-bash">tfenv use 0.13.6
<span class="hljs-built_in">cd</span> cumulus-tf
terraform init -reconfigure
terraform destroy
</code></pre>
<p>The next step is to <em>manually</em> <strong>delete the DynamoDB tables</strong> related to your
deployment. Again, these tables are protected such that they are <strong>not</strong>
<em>automatically</em> deleted by the <code>terraform destroy</code> command. This is a safety
measure to prevent <em>accidental</em> removal.</p>
<p>However, this does not prevent manual destruction in case you truly do wish to
remove them. You may do so via either the <strong>AWS Management Console</strong> or the
<strong>AWS CLI</strong>. As an additional precaution, you may want to create a backup for
each table in your deployment <em>before</em> you delete them.</p>
<p>Then, <strong>destroy the resources for your <code>data-persistence</code> module</strong>:</p>
<pre><code class="hljs css language-bash"><span class="hljs-built_in">cd</span> ../data-persistence-tf
terraform init -reconfigure
terraform destroy
</code></pre>
<p>Destroying your data persistence layer does not destroy any of your RDS resources. Next, <strong>destroy your database resources</strong>.</p>
<p>To teardown the entire cluster, if it was deployed by Terraform, use the <code>terraform destroy</code> command to delete your cluster.</p>
<p>If using a shared cluster and you just want to destroy the database created by Cumulus for your deployment you must manually delete that individual database. The database is named <code>&lt;prefix&gt;_db</code>.</p>
<p>Delete any manual backups you have made that are no longer needed.</p>
<p>Finally, since we tag the resources in your deployment, you should see if there
are any dangling resources left behind for any reason, by running the following
AWS CLI command, replacing <code>PREFIX</code> with your deployment prefix name:</p>
<pre><code class="hljs css language-bash">aws resourcegroupstaggingapi get-resources \
  --query <span class="hljs-string">"ResourceTagMappingList[].ResourceARN"</span> \
  --tag-filters Key=Deployment,Values=PREFIX
</code></pre>
<p>Ideally, the output should be an empty list, but if it is not, then you may
need to manually delete the listed resources.</p>
</span></div></article></div><div class="docs-prevnext"><a class="docs-prev button" href="/cumulus/docs/v13.2.0/deployment/create_bucket"><span class="arrow-prev">← </span><span>Creating an S3 Bucket</span></a><a class="docs-next button" href="/cumulus/docs/v13.2.0/deployment/choosing_configuring_rds"><span>Choosing and Configuration Your RDS Database</span><span class="arrow-next"> →</span></a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#how-to-manage-the-terraform-state-bucket">How to Manage the Terraform State Bucket</a><ul class="toc-headings"><li><a href="#enable-bucket-versioning">Enable Bucket Versioning</a></li><li><a href="#deny-deletebucket-action">Deny DeleteBucket Action</a></li></ul></li><li><a href="#change-resources-only-via-terraform">Change Resources Only via Terraform</a><ul class="toc-headings"><li><a href="#avoid-changing-connectivity-resources">Avoid Changing Connectivity Resources</a></li><li><a href="#how-to-reconcile-differences">How to Reconcile Differences</a></li></ul></li><li><a href="#how-to-destroy-everything">How to Destroy Everything</a></li></ul></nav></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script><script>
                document.addEventListener('keyup', function(e) {
                  if (e.target !== document.body) {
                    return;
                  }
                  // keyCode for '/' (slash)
                  if (e.keyCode === 191) {
                    const search = document.getElementById('search_input_react');
                    search && search.focus();
                  }
                });
              </script><script>
              var search = docsearch({
                
                apiKey: '1a3df8fed03e0ad718e663c44a94fe41',
                indexName: 'nasa_cumulus',
                inputSelector: '#search_input_react',
                algoliaOptions: {"facetFilters":["version:v13.2.0"]}
              });
            </script></body></html>