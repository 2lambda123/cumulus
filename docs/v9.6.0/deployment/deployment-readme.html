<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>How to Deploy Cumulus · Cumulus Documentation</title><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta name="generator" content="Docusaurus"/><meta name="description" content="## Overview"/><meta name="docsearch:version" content="v9.6.0"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="How to Deploy Cumulus · Cumulus Documentation"/><meta property="og:type" content="website"/><meta property="og:url" content="https://nasa.github.io/cumulus/"/><meta property="og:description" content="## Overview"/><meta name="twitter:card" content="summary"/><link rel="shortcut icon" href="/cumulus/undefined"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script src="https://unpkg.com/vanilla-back-to-top@7.1.14/dist/vanilla-back-to-top.min.js"></script><script>
        document.addEventListener('DOMContentLoaded', function() {
          addBackToTop(
            {"zIndex":100,"backgroundColor":"#2276AC"}
          )
        });
        </script><script src="/cumulus/js/scrollSpy.js"></script><link rel="stylesheet" href="/cumulus/css/main.css"/><script src="/cumulus/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/cumulus/"><h2 class="headerTitle">Cumulus Documentation</h2></a><a href="/cumulus/versions"><h3>v9.6.0</h3></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class=""><a href="https://nasa.github.io/cumulus-api" target="_self">API Docs</a></li><li class=""><a href="https://nasa.github.io/cumulus-distribution-api" target="_self">Distribution API Docs</a></li><li class="siteNavGroupActive"><a href="/cumulus/docs/v9.6.0/cumulus-docs-readme" target="_self">Developer Docs</a></li><li class=""><a href="/cumulus/docs/v9.6.0/data-cookbooks/about-cookbooks" target="_self">Data-Cookbooks</a></li><li class=""><a href="/cumulus/docs/v9.6.0/operator-docs/about-operator-docs" target="_self">Operator Docs</a></li><li class="navSearchWrapper reactNavSearchWrapper"><input type="text" id="search_input_react" placeholder="Search" title="Search"/></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>Deployment</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Getting Started<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/cumulus/docs/v9.6.0/cumulus-docs-readme">Introduction</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v9.6.0/getting-started">Getting Started</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v9.6.0/glossary">Glossary</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v9.6.0/faqs">Frequently Asked Questions</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">About Cumulus<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/cumulus/docs/v9.6.0/architecture">Architecture</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v9.6.0/interfaces">Interfaces</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v9.6.0/team">Cumulus Team</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Overviews<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/cumulus/docs/v9.6.0/workflows/workflows-readme">Workflows</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v9.6.0/workflows/protocol">Workflow Protocol</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v9.6.0/workflows/input_output">Workflow Inputs &amp; Outputs</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v9.6.0/workflows/cumulus-task-message-flow">Cumulus Tasks: Message Flow</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v9.6.0/workflows/workflow-triggers">Workflow Triggers</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Deployment<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem navListItemActive"><a class="navItem" href="/cumulus/docs/v9.6.0/deployment/deployment-readme">How to Deploy Cumulus</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v9.6.0/deployment/create_bucket">Creating an S3 Bucket</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v9.6.0/deployment/terraform-best-practices">Terraform Best Practices</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v9.6.0/deployment/postgres_database_deployment">PostgreSQL Database Deployment</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v9.6.0/deployment/components">Component-based Cumulus Deployment</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v9.6.0/deployment/thin_egress_app">Using the Thin Egress App for Cumulus distribution</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v9.6.0/deployment/cumulus_distribution">Using the Cumulus Distribution API</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v9.6.0/deployment/api-gateway-logging">API Gateway Logging</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v9.6.0/deployment/share-s3-access-logs">Share S3 Access Logs</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v9.6.0/deployment/cloudwatch-logs-delivery">Configure Cloudwatch Logs Delivery</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v9.6.0/deployment/upgrade-readme">Upgrading Cumulus</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Configuration<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/cumulus/docs/v9.6.0/configuration/monitoring-readme">Monitoring Best Practices</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v9.6.0/configuration/server_access_logging">S3 Server Access Logging</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v9.6.0/configuration/cloudwatch-retention">Cloudwatch Retention</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v9.6.0/configuration/lifecycle-policies">Setting S3 Lifecycle Policies</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v9.6.0/configuration/collection-storage-best-practices">Collection Cost Tracking and Storage Best Practices</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v9.6.0/configuration/ingest-task-configuration">Configuration of Ingest Tasks</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Development<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/cumulus/docs/v9.6.0/workflows/developing-a-cumulus-workflow">Creating a Cumulus Workflow</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v9.6.0/workflows/developing-workflow-tasks">Developing Workflow Tasks</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v9.6.0/workflows/lambda">Develop Lambda Functions</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v9.6.0/workflows/docker">Dockerizing Data Processing</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v9.6.0/workflows/workflow-configuration-how-to">Workflow Configuration How To&#x27;s</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Workflow Tasks<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/cumulus/docs/v9.6.0/tasks">Cumulus Tasks</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v9.6.0/workflow_tasks/discover_granules">Discover Granules</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v9.6.0/workflow_tasks/files_to_granules">Files To Granules</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v9.6.0/workflow_tasks/move_granules">Move Granules</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v9.6.0/workflow_tasks/parse_pdr">Parse PDR</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Features<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/cumulus/docs/v9.6.0/features/backup_and_restore">Cumulus Backup and Restore</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v9.6.0/features/data_in_dynamodb">Cumulus Metadata in DynamoDB</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v9.6.0/features/dead_letter_queues">Dead Letter Queues</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v9.6.0/features/ems_reporting">EMS Reporting</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v9.6.0/features/execution_payload_retention">Execution Payload Retention</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v9.6.0/features/reports">Reconciliation Reports</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v9.6.0/features/lambda_versioning">Lambda Versioning</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v9.6.0/features/ancillary_metadata">Ancillary Metadata Export</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v9.6.0/features/distribution-metrics">Cumulus Distribution Metrics</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v9.6.0/features/logging-esdis-metrics">Writing logs for ESDIS Metrics</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Troubleshooting<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/cumulus/docs/v9.6.0/troubleshooting/troubleshooting-readme">How to Troubleshoot and Fix Issues</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v9.6.0/troubleshooting/troubleshooting-deployment">Troubleshooting Deployment</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v9.6.0/troubleshooting/reindex-elasticsearch">Reindexing Elasticsearch Guide</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Cumulus Development<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/cumulus/docs/v9.6.0/adding-a-task">Contributing a Task</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v9.6.0/docs-how-to">Cumulus Documentation: How To&#x27;s</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Integrator Guide<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/cumulus/docs/v9.6.0/integrator-guide/about-int-guide">About Integrator Guide</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v9.6.0/integrator-guide/int-common-use-cases">Integrator Common Use Cases</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v9.6.0/integrator-guide/workflow-add-new-lambda">Workflow - Add New Lambda</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v9.6.0/integrator-guide/workflow-ts-failed-step">Workflow - Troubleshoot Failed Step(s)</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Upgrade Notes<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/cumulus/docs/v9.6.0/upgrade-notes/migrate_tea_standalone">Migrate TEA deployment to standalone module</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v9.6.0/upgrade-notes/upgrade_tf_version_0.13.6">Upgrade to TF version 0.13.6</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v9.6.0/upgrade-notes/upgrade-rds">Upgrade to RDS release</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v9.6.0/upgrade-notes/cumulus_distribution_migration">Migrate from TEA deployment to Cumulus Distribution</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">External Contributions<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/cumulus/docs/v9.6.0/external-contributions/external-contributions">External Contributions</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              var headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                var el = event.target;
                while(el !== headings){
                  if (el.tagName === 'A') {
                    document.body.classList.remove('tocActive');
                    break;
                  } else{
                    el = el.parentNode;
                  }
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer docsContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1 id="__docusaurus" class="postHeaderTitle">How to Deploy Cumulus</h1></header><article><div><span><h2><a class="anchor" aria-hidden="true" id="overview"></a><a href="#overview" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Overview</h2>
<p>This is a guide for deploying a new instance of Cumulus.</p>
<p>This document assumes familiarity with Terraform. If you are not comfortable
working with Terraform, the following links should bring you up to speed:</p>
<ul>
<li><a href="https://www.terraform.io/intro/index.html">Introduction to Terraform</a></li>
<li><a href="https://learn.hashicorp.com/terraform/?track=getting-started#getting-started">Getting Started with Terraform and AWS</a></li>
<li><a href="https://www.terraform.io/docs/configuration/index.html">Terraform Configuration Language</a></li>
</ul>
<p>The process involves:</p>
<ul>
<li>Creating <a href="https://docs.aws.amazon.com/AmazonS3/latest/dev/UsingBucket.html">AWS S3 Buckets</a></li>
<li>Configuring a VPC, if necessary</li>
<li>Configuring an Earthdata application, if necessary</li>
<li>Creating/configuring a <a href="../deployment/postgres_database_deployment">PostgreSQL 10.2 compatible database</a>, and an AWS Secrets Manager secret to allow database access</li>
<li>Creating a Lambda layer for the <a href="/cumulus/docs/v9.6.0/workflows/input_output#cumulus-message-adapter">Cumulus Message Adapter</a></li>
<li>Creating resources for your Terraform backend</li>
<li>Using <a href="https://www.terraform.io">Terraform</a> to deploy resources to AWS</li>
</ul>
<hr>
<h2><a class="anchor" aria-hidden="true" id="requirements"></a><a href="#requirements" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Requirements</h2>
<h3><a class="anchor" aria-hidden="true" id="linuxmacos-software-requirements"></a><a href="#linuxmacos-software-requirements" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Linux/MacOS software requirements</h3>
<ul>
<li>git</li>
<li>zip</li>
<li>AWS CLI - <a href="https://aws.amazon.com/cli/">AWS command line interface</a></li>
<li><a href="https://www.terraform.io">Terraform</a></li>
</ul>
<h3><a class="anchor" aria-hidden="true" id="install-terraform"></a><a href="#install-terraform" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Install Terraform</h3>
<p>It is recommended to keep a consistent version of Terraform as you deploy. Once your state files are migrated to a higher version, they are not always backwards compatible so integrators should pin their Terraform version. This is easily accomplished using the Terraform Version Manager <a href="https://github.com/tfutils/tfenv">tfenv</a>. If you have a CI environment (or any other machine) that you are using to deploy the same stack, <strong>you should pin your version across those machines as well</strong>, otherwise you will run into errors trying to re-deploy from your local machine.</p>
<p>If you are using a Mac and <a href="https://brew.sh">Homebrew</a>, installing tfenv is
as simple as:</p>
<pre><code class="hljs css language-shell">brew update
brew install tfenv
</code></pre>
<p>For other cases,
<a href="https://github.com/tfutils/tfenv#installation">installation instructions</a>
are available.</p>
<pre><code class="hljs css language-shell"><span class="hljs-meta"> $</span><span class="bash"> tfenv install 0.13.6</span>
[INFO] Installing Terraform v0.13.6
...
[INFO] Switching completed
<span class="hljs-meta">
$</span><span class="bash"> tfenv use 0.13.6</span>
[INFO] Switching to v0.13.6
...
[INFO] Switching completed
</code></pre>
<p>It is recommended to stay on the Cumulus Core TF version which can be found <a href="https://github.com/nasa/cumulus/blob/master/example/.tfversion">here</a>. Any changes to that will be noted in the release notes.</p>
<p>To verify your Terraform version run:</p>
<pre><code class="hljs css language-shell"><span class="hljs-meta">$</span><span class="bash"> terraform --version</span>
Terraform v0.13.6
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="credentials"></a><a href="#credentials" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Credentials</h3>
<ul>
<li><a href="https://earthdata.nasa.gov/about/science-system-description/eosdis-components/common-metadata-repository">CMR</a> username and password. CMR credentials must be provided if you are exporting metadata to CMR with Earthdata Login authentication.</li>
<li><a href="https://launchpad.nasa.gov">NASA Launchpad</a>. Launchpad credentials must be provided if you are using Launchpad authentication to export metadata to CMR or to authenticate with the Cumulus API.</li>
<li><a href="https://earthdata.nasa.gov/about/science-system-description/eosdis-components/earthdata-login">Earthdata Login</a> username and password. User must have the ability to administer and/or create applications in URS. It's recommended to obtain an account in the test environment (UAT).</li>
</ul>
<h3><a class="anchor" aria-hidden="true" id="needed-git-repositories"></a><a href="#needed-git-repositories" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Needed Git Repositories</h3>
<ul>
<li><a href="https://github.com/nasa/cumulus-template-deploy">Deployment Template</a></li>
<li><a href="https://github.com/nasa/cumulus-dashboard">Cumulus Dashboard</a></li>
</ul>
<hr>
<h2><a class="anchor" aria-hidden="true" id="prepare-deployment-repository"></a><a href="#prepare-deployment-repository" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Prepare deployment repository</h2>
<blockquote>
<p><em>If you already are working with an existing repository that is configured appropriately for the version of Cumulus you intend to deploy or update, skip to <a href="deployment-readme#prepare-aws-configuration">Prepare AWS configuration.</a></em></p>
</blockquote>
<p>Clone the <a href="https://github.com/nasa/cumulus-template-deploy"><code>cumulus-template-deploy</code></a> repo and name appropriately for your organization:</p>
<pre><code class="hljs css language-bash">  git <span class="hljs-built_in">clone</span> https://github.com/nasa/cumulus-template-deploy &lt;repository-name&gt;
</code></pre>
<p>We will return to <a href="#deploying-the-cumulus-instance">configuring this repo and using it for deployment below</a>.</p>
<p><details>
<summary>Optional: Create a new repository</summary></p>
<p><a href="https://help.github.com/articles/creating-a-new-repository/">Create a new repository</a> on Github so that you can add your workflows and other modules to source control:</p>
<pre><code class="hljs css language-bash">  git remote <span class="hljs-built_in">set</span>-url origin https://github.com/nasa/&lt;repository-name&gt;
  git push origin master
</code></pre>
<p>You can then <a href="https://help.github.com/articles/adding-a-file-to-a-repository-using-the-command-line/">add/commit</a> changes as needed.</p>
<blockquote>
<p><strong>Note</strong>: If you are pushing your deployment code to a git repo, make sure to add <code>terraform.tf</code> and <code>terraform.tfvars</code> to <code>.gitignore</code>, <strong>as these files will contain sensitive data related to your AWS account</strong>.</p>
</blockquote>
<p></details></p>
<hr>
<h2><a class="anchor" aria-hidden="true" id="prepare-aws-configuration"></a><a href="#prepare-aws-configuration" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Prepare AWS configuration</h2>
<h3><a class="anchor" aria-hidden="true" id="set-access-keys"></a><a href="#set-access-keys" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Set Access Keys</h3>
<p>You need to make some AWS information available to your environment. If you don't already have the access key and secret access key of an AWS user with IAM Create-User permissions, you must <a href="https://docs.aws.amazon.com/general/latest/gr/managing-aws-access-keys.html">Create Access Keys</a> for such a user with IAM Create-User permissions, then export the access keys:</p>
<pre><code class="hljs css language-bash">  <span class="hljs-built_in">export</span> AWS_ACCESS_KEY_ID=&lt;AWS access key&gt;
  <span class="hljs-built_in">export</span> AWS_SECRET_ACCESS_KEY=&lt;AWS secret key&gt;
  <span class="hljs-built_in">export</span> AWS_REGION=&lt;region&gt;
</code></pre>
<p>If you don't want to set environment variables, <a href="http://docs.aws.amazon.com/cli/latest/userguide/cli-chap-getting-started.html">access keys can be stored locally via the AWS CLI.</a></p>
<h3><a class="anchor" aria-hidden="true" id="create-s3-buckets"></a><a href="#create-s3-buckets" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Create S3 Buckets</h3>
<p>See <a href="/cumulus/docs/v9.6.0/deployment/create_bucket">creating s3 buckets</a> for more information on how to create a bucket.</p>
<p>The following s3 bucket should be created (replacing <code>&lt;prefix&gt;</code> with whatever you'd like, generally your organization/DAAC's name):</p>
<ul>
<li><code>&lt;prefix&gt;-internal</code></li>
</ul>
<p>You can create additional s3 buckets based on the needs of your workflows.</p>
<p>These buckets do not need any non-default permissions to function with Cumulus, however your local security requirements may vary.</p>
<p><strong>Note</strong>: S3 bucket object names are global and must be unique across all accounts/locations/etc.</p>
<h3><a class="anchor" aria-hidden="true" id="vpc-subnets-and-security-group"></a><a href="#vpc-subnets-and-security-group" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>VPC, Subnets and Security Group</h3>
<p>Cumulus supports operation within a VPC, but you will need to separately create:</p>
<ul>
<li>VPC</li>
<li>Subnet</li>
<li>Security group</li>
<li>VPC endpoints for the various services used by Cumulus if you wish to route traffic through the VPC</li>
</ul>
<p>These resources only need to be created once per AWS account and their ids will be used to configure your Terraform deployment.</p>
<h4><a class="anchor" aria-hidden="true" id="elasticsearch-in-a-vpc"></a><a href="#elasticsearch-in-a-vpc" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Elasticsearch in a VPC</h4>
<p>Amazon Elasticsearch Service does not use a VPC Endpoint. To use ES within a VPC, before deploying run:</p>
<pre><code class="hljs css language-shell">aws iam create-service-linked-role --aws-service-name es.amazonaws.com
</code></pre>
<p>This operation only needs to be done once per account, but it must be done for both NGAP and regular AWS environments.</p>
<h3><a class="anchor" aria-hidden="true" id="look-up-ecs-optimized-ami-deprecated"></a><a href="#look-up-ecs-optimized-ami-deprecated" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Look up ECS-optimized AMI (DEPRECATED)</h3>
<blockquote>
<p><strong>Note:</strong> This step is unnecessary if you using the latest changes in the <a href="https://github.com/nasa/cumulus-template-deploy/commit/8472e2f3a7185d77bb68bf9e0f21a92a91b0cba9"><code>cumulus-template-deploy</code> repo which will automatically determine the AMI ID for you
based on your <code>deploy_to_ngap</code> variable</a>.</p>
</blockquote>
<p>Look up the recommended machine image ID for the Linux version and AWS region of your deployment. See <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/ecs-optimized_AMI.html#ecs-optimized-ami-linux">Linux Amazon ECS-optimized AMIs docs</a>. The image ID, beginning with <code>ami-</code>, will be assigned to the <code>ecs_cluster_instance_image_id</code> variable for the <a href="https://github.com/nasa/cumulus/blob/master/tf-modules/cumulus/variables.tf">cumulus-tf module</a>.</p>
<h3><a class="anchor" aria-hidden="true" id="set-up-ec2-key-pair-optional"></a><a href="#set-up-ec2-key-pair-optional" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Set up EC2 key pair (optional)</h3>
<p>The key pair will be used to SSH into your EC2 instance(s). It is recommended to <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-key-pairs.html">create or import a key pair</a> and specify it in your Cumulus deployment.</p>
<p>This can also be done post-deployment by redeploying your Cumulus instance.</p>
<hr>
<h2><a class="anchor" aria-hidden="true" id="configure-earthdata-application"></a><a href="#configure-earthdata-application" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Configure EarthData application</h2>
<p>The Cumulus stack can authenticate with <a href="https://urs.earthdata.nasa.gov/documentation">Earthdata Login</a>. If you want to use this functionality, you must create and register a new Earthdata application. Use the <a href="https://uat.urs.earthdata.nasa.gov">User Acceptance Tools (UAT) site</a> unless you intend use a different URS environment (which will require updating the <code>urs_url</code> value shown below).</p>
<p>Follow the directions on <a href="https://wiki.earthdata.nasa.gov/display/EL/How+To+Register+An+Application">how to register an application</a>. Use any url for the <code>Redirect URL</code>, it will be deleted in a later step. Also note the password in step 3 and client ID in step 4 use these to replace <code>urs_client_id</code> and <code>urs_client_password</code> in the <code>terraform.tfvars</code> for the <code>cumulus-tf</code> module shown below.</p>
<hr>
<h2><a class="anchor" aria-hidden="true" id="create-resources-for-terraform-state"></a><a href="#create-resources-for-terraform-state" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Create resources for Terraform state</h2>
<blockquote>
<p><em>If you're re-deploying an existing Cumulus configuration you should skip to <a href="deployment-readme#deploy-the-cumulus-instance">Deploy the Cumulus instance</a>, as these values should already be configured.</em></p>
</blockquote>
<p>The state of the Terraform deployment is stored in S3. In the following examples, it will be assumed that state is being stored in a bucket called <code>my-tf-state</code>. You can also use an existing bucket, if desired.</p>
<h3><a class="anchor" aria-hidden="true" id="create-the-state-bucket"></a><a href="#create-the-state-bucket" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Create the state bucket</h3>
<pre><code class="hljs css language-shell">aws s3api create-bucket --bucket my-tf-state
</code></pre>
<p>In order to help prevent loss of state information, <strong>it is strongly recommended that versioning be enabled on the state bucket</strong>.</p>
<pre><code class="hljs css language-shell">aws s3api put-bucket-versioning \
    --bucket my-tf-state \
    --versioning-configuration Status=Enabled
</code></pre>
<p>⚠️ <strong>Note:</strong> If your state information does become lost or corrupt, then deployment (via <code>terraform apply</code>) will have unpredictable results, including possible loss of data and loss of deployed resources. In order to reduce your risk of the corruption or loss of your Terraform state file, or otherwise corrupt your Cumulus deployment, please see the <a href="/cumulus/docs/v9.6.0/deployment/terraform-best-practices">Terraform Best Practices</a> guide.</p>
<h3><a class="anchor" aria-hidden="true" id="create-the-locks-table"></a><a href="#create-the-locks-table" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Create the locks table</h3>
<p>Terraform uses a lock stored in DynamoDB in order to prevent multiple simultaneous updates. In the following examples, that table will be called <code>my-tf-locks</code>.</p>
<pre><code class="hljs css language-shell"><span class="hljs-meta">$</span><span class="bash"> aws dynamodb create-table \</span>
    --table-name my-tf-locks \
    --attribute-definitions AttributeName=LockID,AttributeType=S \
    --key-schema AttributeName=LockID,KeyType=HASH \
    --billing-mode PAY_PER_REQUEST \
    --region us-east-1
</code></pre>
<hr>
<h2><a class="anchor" aria-hidden="true" id="configure-the-postgresql-database"></a><a href="#configure-the-postgresql-database" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Configure the PostgreSQL database</h2>
<p>Cumulus requires a PostgreSQL 10.2 compatible database cluster deployed to AWS.    We suggest utilizing <a href="https://docs.aws.amazon.com/rds/index.html">RDS</a>, and have provided a default <a href="PostgreSQL_database_deployment">template and RDS cluster module</a> utilizing Aurora Serverless. However, Core intentionally provides a &quot;bring your own&quot; approach, and any well-planned cluster setup should work, given the following:</p>
<ul>
<li>Appropriate testing/evaluation is given to ensure the database capacity will scale and the database deployment will allow access to Cumulus's internal components.   Core provides for security-group oriented permissions management via the <code>rds_security_group</code> configuration parameter.</li>
<li>The database is configured such that its endpoint is accessible from the VPC and subnets configured for the Core deployment.</li>
<li>An AWS Secrets Manager secret exists that has the following format:</li>
</ul>
<pre><code class="hljs css language-json">{
  <span class="hljs-attr">"database"</span>: <span class="hljs-string">"databaseName"</span>,
  <span class="hljs-attr">"host"</span>: <span class="hljs-string">"xxx"</span>,
  <span class="hljs-attr">"password"</span>: <span class="hljs-string">"defaultPassword"</span>,
  <span class="hljs-attr">"port"</span>: <span class="hljs-number">5432</span>,
  <span class="hljs-attr">"username"</span>: <span class="hljs-string">"xxx"</span>
}
</code></pre>
<ul>
<li><code>database</code> -- the PostgreSQL database used by the configured user</li>
<li><code>host</code> -- the RDS service host for the database in the form (dbClusterIdentifier)-(AWS ID string).(region).rds.amazonaws.com</li>
<li><code>password</code> -- the database password</li>
<li><code>port</code> -- The database connection port, should always be 5432</li>
<li><code>username</code> -- the database username</li>
</ul>
<p>This secret should provide access to a PostgreSQL database provisioned on the cluster.</p>
<p>To configure Cumulus you will need:</p>
<ul>
<li>The AWS Secrets Manager ARN for the <em>user</em> Core will write with (e.g. <code>arn:aws:secretsmanager:AWS-REGION:xxxxx:secret:xxxxxxxxxx20210407182709367700000002-dpmpXA</code> ) for use in configuring <code>rds_user_access_secret_arn</code>.</li>
<li>(Optionally) The security group ID that provides access to the cluster to configure <code>rds_security_group</code>.</li>
</ul>
<hr>
<h2><a class="anchor" aria-hidden="true" id="deploy-the-cumulus-instance"></a><a href="#deploy-the-cumulus-instance" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Deploy the Cumulus instance</h2>
<p>A typical Cumulus deployment is broken into two
<a href="https://www.terraform.io/docs/configuration/modules.html">Terraform root modules</a>:
<a href="https://github.com/nasa/cumulus/tree/master/tf-modules/data-persistence"><code>data-persistence</code></a> and <a href="https://github.com/nasa/cumulus/tree/master/tf-modules/cumulus"><code>cumulus</code></a>.</p>
<p>The <code>data-persistence</code> module should be deployed first, and creates the Elasticsearch domain and DynamoDB tables. The <code>cumulus</code> module deploys the rest of Cumulus: distribution, API, ingest, workflows, etc. The <code>cumulus</code> module depends on the resources created in the <code>data-persistence</code> deployment.</p>
<p>Each of these modules have to be deployed independently and require their own Terraform backend, variable, and output settings. The template deploy repo that was cloned previously already contains the scaffolding of the necessary files for the deployment of each module: <code>data-persistence-tf</code> deploys the <code>data-persistence</code> module and <code>cumulus-tf</code> deploys the <code>cumulus</code> module. For reference on the files that are included, see the <a href="/cumulus/docs/v9.6.0/deployment/components#adding-components-to-your-terraform-deployment">documentation on adding components to a Terraform deployment</a>.</p>
<h3><a class="anchor" aria-hidden="true" id="troubleshooting"></a><a href="#troubleshooting" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Troubleshooting</h3>
<p>Please see our <a href="../troubleshooting/troubleshooting-deployment">troubleshooting documentation for any issues with your deployment</a> when performing the upcoming steps.</p>
<h3><a class="anchor" aria-hidden="true" id="configure-and-deploy-the-data-persistence-tf-root-module"></a><a href="#configure-and-deploy-the-data-persistence-tf-root-module" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Configure and deploy the <code>data-persistence-tf</code> root module</h3>
<p>These steps should be executed in the <code>data-persistence-tf</code> directory of the template deploy repo that you previously cloned. Run the following to copy the example files.</p>
<pre><code class="hljs css language-shell">cd data-persistence-tf/
cp terraform.tf.example terraform.tf
cp terraform.tfvars.example terraform.tfvars
</code></pre>
<p>In <code>terraform.tf</code>, configure the remote state settings by substituting the appropriate values for:</p>
<ul>
<li><code>bucket</code></li>
<li><code>dynamodb_table</code></li>
<li><code>PREFIX</code> (whatever prefix you've chosen for your deployment)</li>
</ul>
<p>Fill in the appropriate values in <code>terraform.tfvars</code>. See the <a href="https://github.com/nasa/cumulus/blob/master/tf-modules/data-persistence/variables.tf">data-persistence module variable definitions</a> for more detail on each variable.</p>
<p>Consider <a href="#elasticsearch">the size of your Elasticsearch cluster</a> when configuring data-persistence.</p>
<p><strong>Reminder:</strong> <em>Elasticsearch is optional and can be disabled using <code>include_elasticsearch = false</code> in your <code>terraform.tfvars</code>. Your Cumulus dashboard will not work without Elasticsearch.</em></p>
<p><strong>Reminder:</strong> <em>If you are including <code>subnet_ids</code> in your <code>terraform.tfvars</code>, Elasticsearch will need a service-linked role to deploy successfully. Follow the <a href="#elasticsearch-in-a-vpc">instructions above</a> to create the service-linked role if you haven't already.</em></p>
<h4><a class="anchor" aria-hidden="true" id="initialize-terraform"></a><a href="#initialize-terraform" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Initialize Terraform</h4>
<p>Run <code>terraform init</code><sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup></p>
<p>You should see output like:</p>
<pre><code class="hljs css language-shell">* provider.aws: version = "~&gt; 2.32"

Terraform has been successfully initialized!
</code></pre>
<p><details>
<summary>Optional: Import existing AWS resources to Terraform</summary></p>
<h4><a class="anchor" aria-hidden="true" id="import-existing-resources"></a><a href="#import-existing-resources" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Import existing resources</h4>
<p>If you have an existing Cumulus deployment, you can import your existing DynamoDB tables and Elasticsearch instance to be used with your new Terraform deployment.</p>
<p>To import a DynamoDB table from your existing deployment:</p>
<pre><code class="hljs css language-bash">terraform import module.data_persistence.aws_dynamodb_table.access_tokens_table PREFIX-AccessTokensTable
</code></pre>
<p>Repeat this command for every DynamoDB table included in the <a href="https://github.com/nasa/cumulus/blob/master/tf-modules/data-persistence/README.md"><code>data-persistence</code> module</a>, replacing <code>PREFIX</code> with the correct value for your existing deployment.</p>
<p>To import the Elasticsearch instance from your existing deployment, run this command and replace <code>PREFIX-es5vpc</code> with the existing domain name:</p>
<pre><code class="hljs css language-bash">terraform import module.data_persistence.aws_elasticsearch_domain.es_vpc PREFIX-es5vpc
</code></pre>
<p>You will also need to make sure to set these variables in your <code>terraform.tfvars</code> file:</p>
<pre><code class="hljs css language-hcl">prefix = <span class="hljs-string">"PREFIX"</span>     # must match<span class="hljs-built_in"> prefix </span>of existing deployment
custom_domain_name = <span class="hljs-string">"PREFIX-es5vpc"</span>  # must match existing Elasticsearch domain name
</code></pre>
<blockquote>
<p><strong>Note:</strong> If you are importing data resources from a previous version of Cumulus deployed using Cloudformation, then make sure <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-attribute-deletionpolicy.html"><code>DeletionPolicy: Retain</code></a> is set on the data resources in the Cloudformation stack before deleting that stack. Otherwise, the imported data resources will be destroyed when you delete that stack. As of Cumulus version 1.15.0, <code>DeletionPolicy: Retain</code> is set by default for the data resources in the Cloudformation stack.</p>
</blockquote>
<p></details></p>
<h4><a class="anchor" aria-hidden="true" id="deploy"></a><a href="#deploy" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Deploy</h4>
<p>Run <code>terraform apply</code> to deploy your data persistence resources. Type <code>yes</code> when prompted to confirm that you want to create the resources. Assuming the operation is successful, you should see output like:</p>
<pre><code class="hljs css language-shell">Apply complete! Resources: 16 added, 0 changed, 0 destroyed.

Outputs:

dynamo_tables = {
  "access_tokens" = {
    "arn" = "arn:aws:dynamodb:us-east-1:12345:table/prefix-AccessTokensTable"
    "name" = "prefix-AccessTokensTable"
  }
<span class="hljs-meta">  #</span><span class="bash"> ... more tables ...</span>
}
elasticsearch_alarms = [
  {
    "arn" = "arn:aws:cloudwatch:us-east-1:12345:alarm:prefix-es-vpc-NodesLowAlarm"
    "name" = "prefix-es-vpc-NodesLowAlarm"
  },
<span class="hljs-meta">  #</span><span class="bash"> ... more alarms ...</span>
]
elasticsearch_domain_arn = arn:aws:es:us-east-1:12345:domain/prefix-es-vpc
elasticsearch_hostname = vpc-prefix-es-vpc-abcdef.us-east-1.es.amazonaws.com
elasticsearch_security_group_id = sg-12345
</code></pre>
<p>Your data persistence resources are now deployed.</p>
<h3><a class="anchor" aria-hidden="true" id="deploy-the-cumulus-message-adapter-layer-deprecated"></a><a href="#deploy-the-cumulus-message-adapter-layer-deprecated" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Deploy the Cumulus Message Adapter layer (DEPRECATED)</h3>
<blockquote>
<p><strong>Note:</strong> This step is unnecessary if you using the latest changes in the <a href="https://github.com/nasa/cumulus-template-deploy/commit/8472e2f3a7185d77bb68bf9e0f21a92a91b0cba9"><code>cumulus-template-deploy</code> repo which will automatically download the Cumulus Message Adapter and create the layer for you based on your <code>cumulus_message_adapter_version</code> variable</a>.</p>
</blockquote>
<p>The <a href="/cumulus/docs/v9.6.0/workflows/input_output#cumulus-message-adapter">Cumulus Message Adapter (CMA)</a> is necessary for interpreting the input and output of Cumulus workflow steps. The CMA is now integrated with Cumulus workflow steps as a Lambda layer.</p>
<p>To deploy a CMA layer to your account:</p>
<ol>
<li>Go to the <a href="https://github.com/nasa/cumulus-message-adapter/releases">CMA releases page</a> and download the <code>cumulus-message-adapter.zip</code> for the desired release</li>
<li>Use the AWS CLI to publish your layer:</li>
</ol>
<pre><code class="hljs css language-shell"><span class="hljs-meta">$</span><span class="bash"> aws lambda publish-layer-version \</span>
  --layer-name prefix-CMA-layer \
  --region us-east-1 \
  --zip-file fileb:///path/to/cumulus-message-adapter.zip
{
  ... more output ...
  "LayerVersionArn": "arn:aws:lambda:us-east-1:1234567890:layer:prefix-CMA-layer:1",
  ... more output ...
}
</code></pre>
<p>Make sure to copy the <code>LayerVersionArn</code> of the deployed layer, as it will be used to configure the <code>cumulus-tf</code> deployment in the next step.</p>
<h3><a class="anchor" aria-hidden="true" id="configure-and-deploy-the-cumulus-tf-root-module"></a><a href="#configure-and-deploy-the-cumulus-tf-root-module" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Configure and deploy the <code>cumulus-tf</code> root module</h3>
<p>These steps should be executed in the <code>cumulus-tf</code> directory of the template repo that was cloned previously.</p>
<pre><code class="hljs css language-shell">cd cumulus-tf/
cp terraform.tf.example terraform.tf
cp terraform.tfvars.example terraform.tfvars
</code></pre>
<p>In <code>terraform.tf</code>, configure the remote state settings by substituting the appropriate values for:</p>
<ul>
<li><code>bucket</code></li>
<li><code>dynamodb_table</code></li>
<li><code>PREFIX</code> (whatever prefix you've chosen for your deployment)</li>
</ul>
<p>Fill in the appropriate values in <code>terraform.tfvars</code>. See the <a href="https://github.com/nasa/cumulus/blob/master/tf-modules/cumulus/variables.tf">Cumulus module variable definitions</a> for more detail on each variable.</p>
<p>Notes on specific variables:</p>
<ul>
<li><strong><code>deploy_to_ngap</code></strong>: This variable controls the provisioning of certain resources and policies that are specific to an NGAP environment. <strong>If you are deploying to NGAP, you must set this variable to <code>true</code>.</strong></li>
<li><strong><code>prefix</code></strong>: The value should be the same as the <code>prefix</code> from the data-persistence deployment.</li>
<li><strong><code>data_persistence_remote_state_config</code></strong>: This object should contain the remote state values that you configured in <code>data-persistence-tf/terraform.tf</code>. These settings allow <code>cumulus-tf</code> to determine the names of the resources created in <code>data-persistence-tf</code>.</li>
<li><strong><code>rds_security_group</code></strong>: The ID of the security group used to allow access to the PostgreSQL database</li>
<li><strong><code>rds_user_access_secret_arn</code></strong>: The ARN for the Secrets Manager secret that provides database access information</li>
<li><strong><code>cumulus_message_adapter_version</code></strong>: The version number (e.g. <code>1.3.0</code>) of the <a href="https://github.com/nasa/cumulus-message-adapter/releases">Cumulus Message Adapter</a> to deploy</li>
<li><strong><code>key_name</code> (optional)</strong>: The name of your key pair from <a href="#set-up-ec2-key-pair-optional">setting up your key pair</a>. Adding your <code>key_name</code> sets the EC2 keypair
for deployment's EC2 instances and allows you to connect to them via <a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/session-manager-working-with-sessions-start.html">SSH/SSM</a>.</li>
</ul>
<p>Consider <a href="#cumulus-instance-sizing">the sizing of your Cumulus instance</a> when configuring your variables.</p>
<h4><a class="anchor" aria-hidden="true" id="choose-a-distribution-api"></a><a href="#choose-a-distribution-api" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Choose a distribution API</h4>
<p>Cumulus can be configured to use either the Thin Egress App (TEA) or the Cumulus Distribution API. The default selection is the Thin Egress App if you're using the <a href="https://github.com/nasa/cumulus-template-deploy">Deployment Template</a>.</p>
<p><strong>IMPORTANT!</strong> If you already have a deployment using the TEA distribution and want to switch to Cumulus Distribution, there will be an API Gateway change. This means that there will be downtime while you update your CloudFront endpoint to use
the new API gateway.</p>
<h4><a class="anchor" aria-hidden="true" id="configure-the-thin-egress-app"></a><a href="#configure-the-thin-egress-app" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Configure the Thin Egress App</h4>
<p>The Thin Egress App can be used for Cumulus distribution and is the default selection. It allows authentication using Earthdata Login. Follow the steps <a href="./thin_egress_app">in the documentation</a> to configure distribution in your <code>cumulus-tf</code> deployment.</p>
<h4><a class="anchor" aria-hidden="true" id="configure-the-cumulus-distribution-api-optional"></a><a href="#configure-the-cumulus-distribution-api-optional" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Configure the Cumulus Distribution API (optional)</h4>
<p>If you would prefer to use the Cumulus Distribution API, which supports <a href="https://aws.amazon.com/cognito/">AWS Cognito authentication</a>, follow <a href="./cumulus_distribution">these steps</a> to configure distribution in your <code>cumulus-tf</code> deployment.</p>
<h4><a class="anchor" aria-hidden="true" id="initialize-terraform-1"></a><a href="#initialize-terraform-1" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Initialize Terraform</h4>
<p>Follow the <a href="#initialize-terraform">above instructions to initialize Terraform</a> using <code>terraform init</code><sup class="footnote-ref"><a href="#fn1" id="fnref1:1">[1]</a></sup>.</p>
<h4><a class="anchor" aria-hidden="true" id="deploy-1"></a><a href="#deploy-1" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Deploy</h4>
<p>Run <code>terraform apply</code> to deploy the resources. Type <code>yes</code> when prompted to confirm that you want to create the resources. Assuming the operation is successful, you should see output like this:</p>
<pre><code class="hljs css language-shell">Apply complete! Resources: 292 added, 0 changed, 0 destroyed.

Outputs:

archive_api_redirect_uri = https://abc123.execute-api.us-east-1.amazonaws.com/dev/token
archive_api_uri = https://abc123.execute-api.us-east-1.amazonaws.com/dev/
distribution_redirect_uri = https://abc123.execute-api.us-east-1.amazonaws.com/DEV/login
distribution_url = https://abc123.execute-api.us-east-1.amazonaws.com/DEV/
</code></pre>
<p><strong>Note:</strong> Be sure to copy the redirect URLs, as you will use them to update your Earthdata application.</p>
<h3><a class="anchor" aria-hidden="true" id="update-earthdata-application"></a><a href="#update-earthdata-application" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Update Earthdata Application</h3>
<p>You will need to add two redirect URLs to your EarthData login application.</p>
<ol>
<li>Login to URS.</li>
<li>Under My Applications -&gt; Application Administration -&gt; use the edit icon of your application.</li>
<li>Under Manage -&gt; redirect URIs, add the Archive API url returned from the stack deployment
<ul>
<li>e.g. <code>archive_api_redirect_uri = https://&lt;czbbkscuy6&gt;.execute-api.us-east-1.amazonaws.com/dev/token</code>.</li>
</ul></li>
<li>Also add the Distribution url
<ul>
<li>e.g. <code>distribution_redirect_uri = https://&lt;kido2r7kji&gt;.execute-api.us-east-1.amazonaws.com/dev/login</code><sup class="footnote-ref"><a href="#fn2" id="fnref2">[2]</a></sup>.</li>
</ul></li>
<li>You may delete the placeholder url you used to create the application.</li>
</ol>
<p>If you've lost track of the needed redirect URIs, they can be located on the <a href="https://console.aws.amazon.com/apigateway">API Gateway</a>. Once there, select <code>&lt;prefix&gt;-archive</code> and/or <code>&lt;prefix&gt;-thin-egress-app-EgressGateway</code>, <code>Dashboard</code> and utilizing the base URL at the top of the page that is accompanied by the text <code>Invoke this API at:</code>. Make sure to append <code>/token</code> for the archive URL and <code>/login</code> to the thin egress app URL.</p>
<hr>
<h2><a class="anchor" aria-hidden="true" id="deploy-cumulus-dashboard"></a><a href="#deploy-cumulus-dashboard" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Deploy Cumulus dashboard</h2>
<h3><a class="anchor" aria-hidden="true" id="dashboard-requirements"></a><a href="#dashboard-requirements" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Dashboard Requirements</h3>
<p>Please note that the requirements are similar to the <a href="deployment-readme#requirements">Cumulus stack deployment requirements</a>. The installation instructions below include a step that will install/use the required node version referenced in the <code>.nvmrc</code> file in the dashboard repository.</p>
<ul>
<li>git</li>
<li><a href="https://nodejs.org/en/">node 12.18</a> (use <a href="https://github.com/creationix/nvm">nvm</a> to upgrade/downgrade)</li>
<li><a href="https://www.npmjs.com/get-npm">npm</a></li>
<li>zip</li>
<li>AWS CLI - <a href="https://aws.amazon.com/cli/">AWS command line interface</a></li>
<li>python</li>
</ul>
<h3><a class="anchor" aria-hidden="true" id="prepare-aws"></a><a href="#prepare-aws" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Prepare AWS</h3>
<p><strong>Create S3 bucket for dashboard:</strong></p>
<ul>
<li>Create it, e.g. <code>&lt;prefix&gt;-dashboard</code>. Use the command line or console as you did when <a href="deployment-readme#prepare-aws-configuration">preparing AWS configuration</a>.</li>
<li>Configure the bucket to host a website:
<ul>
<li>AWS S3 console: Select <code>&lt;prefix&gt;-dashboard</code> bucket then, &quot;Properties&quot; -&gt; &quot;Static Website Hosting&quot;, point to <code>index.html</code></li>
<li>CLI: <code>aws s3 website s3://&lt;prefix&gt;-dashboard --index-document index.html</code></li>
</ul></li>
<li>The bucket's url will be <code>http://&lt;prefix&gt;-dashboard.s3-website-&lt;region&gt;.amazonaws.com</code> or you can find it on the AWS console via &quot;Properties&quot; -&gt; &quot;Static website hosting&quot; -&gt; &quot;Endpoint&quot;</li>
<li>Ensure the bucket's access permissions allow your deployment user access to write to the bucket</li>
</ul>
<h3><a class="anchor" aria-hidden="true" id="install-dashboard"></a><a href="#install-dashboard" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Install dashboard</h3>
<p>To install the dashboard, clone the <a href="https://github.com/nasa/cumulus-dashboard">Cumulus dashboard</a> repository into the root deploy directory and install dependencies with <code>npm install</code>:</p>
<pre><code class="hljs css language-bash">  git <span class="hljs-built_in">clone</span> https://github.com/nasa/cumulus-dashboard
  <span class="hljs-built_in">cd</span> cumulus-dashboard
  nvm use
  npm install
</code></pre>
<p>If you do not have the correct version of node installed, replace <code>nvm use</code> with <code>nvm install $(cat .nvmrc)</code> in the above example.</p>
<h4><a class="anchor" aria-hidden="true" id="dashboard-versioning"></a><a href="#dashboard-versioning" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Dashboard versioning</h4>
<p>By default, the <code>master</code> branch will be used for dashboard deployments. The <code>master</code> branch of the dashboard repo contains the most recent stable release of the dashboard.</p>
<p>If you want to test unreleased changes to the dashboard, use the <code>develop</code> branch.</p>
<p>Each <a href="https://github.com/nasa/cumulus-dashboard/releases">release/version of the dashboard</a> will have <a href="https://github.com/nasa/cumulus-dashboard/tags">a tag in the dashboard repo</a>. Release/version numbers will use semantic versioning (major/minor/patch).</p>
<p>To checkout and install a specific version of the dashboard:</p>
<pre><code class="hljs css language-bash">  git fetch --tags
  git checkout &lt;version-number&gt; <span class="hljs-comment"># e.g. v1.2.0</span>
  nvm use
  npm install
</code></pre>
<p>If you do not have the correct version of node installed, replace <code>nvm use</code> with <code>nvm install $(cat .nvmrc)</code> in the above example.</p>
<h3><a class="anchor" aria-hidden="true" id="building-the-dashboard"></a><a href="#building-the-dashboard" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Building the dashboard</h3>
<p><strong>Note</strong>: These environment variables are available during the build: <code>APIROOT</code>, <code>DAAC_NAME</code>, <code>STAGE</code>, <code>HIDE_PDR</code>. Any of these can be set on the command line to override the values contained in <code>config.js</code> when running the build below.</p>
<p>To configure your dashboard for deployment, set the <code>APIROOT</code> environment variable to your app's API root.<sup class="footnote-ref"><a href="#fn3" id="fnref3">[3]</a></sup></p>
<p>Build the dashboard from the dashboard repository root directory, <code>cumulus-dashboard</code>:</p>
<pre><code class="hljs css language-bash">  APIROOT=&lt;your_api_root&gt; npm run build
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="dashboard-deployment"></a><a href="#dashboard-deployment" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Dashboard deployment</h3>
<p>Deploy dashboard to s3 bucket from the <code>cumulus-dashboard</code> directory:</p>
<p>Using AWS CLI:</p>
<pre><code class="hljs css language-bash">  aws s3 sync dist s3://&lt;prefix&gt;-dashboard --acl public-read
</code></pre>
<p>From the S3 Console:</p>
<ul>
<li>Open the <code>&lt;prefix&gt;-dashboard</code> bucket, click 'upload'. Add the contents of the 'dist' subdirectory to the upload. Then select 'Next'. On the permissions window allow the public to view. Select 'Upload'.</li>
</ul>
<p>You should be able to visit the dashboard website at <code>http://&lt;prefix&gt;-dashboard.s3-website-&lt;region&gt;.amazonaws.com</code> or find the url
<code>&lt;prefix&gt;-dashboard</code> -&gt; &quot;Properties&quot; -&gt; &quot;Static website hosting&quot; -&gt; &quot;Endpoint&quot; and login with a user that you configured for access in the <a href="deployment-readme#configure-and-deploy-the-cumulus-stack">Configure and Deploy the Cumulus Stack</a> step.</p>
<hr>
<h2><a class="anchor" aria-hidden="true" id="cumulus-instance-sizing"></a><a href="#cumulus-instance-sizing" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Cumulus Instance Sizing</h2>
<p>The Cumulus deployment default sizing for Elasticsearch instances, EC2 instances, and Autoscaling Groups are small and designed for testing and cost savings. The default settings are likely not suitable for production workloads. Sizing is highly individual and dependent on expected load and archive size.</p>
<blockquote>
<p>Please be cognizant of costs as any change in size will affect your AWS bill. AWS provides a <a href="https://calculator.aws/#/">pricing calculator</a> for estimating costs.</p>
</blockquote>
<h3><a class="anchor" aria-hidden="true" id="elasticsearch"></a><a href="#elasticsearch" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Elasticsearch</h3>
<p>The <a href="https://github.com/nasa/cumulus/blob/master/packages/api/models/mappings.json">mappings file</a> contains all of the data types that will be indexed into Elasticsearch. Elasticsearch sizing is tied to your archive size, including your collections, granules, and workflow executions that will be stored.</p>
<p>AWS provides <a href="https://docs.aws.amazon.com/elasticsearch-service/latest/developerguide/sizing-domains.html">documentation</a> on calculating and configuring for sizing.</p>
<p>In addition to size you'll want to consider the <a href="https://docs.aws.amazon.com/elasticsearch-service/latest/developerguide/es-managedomains-dedicatedmasternodes.html">number of nodes</a> which determine how the system reacts in the event of a failure.</p>
<p>Configuration can be done in the <a href="https://github.com/nasa/cumulus/blob/master/tf-modules/data-persistence/variables.tf#L16">data persistence module</a> in <code>elasticsearch_config</code> and the <a href="https://github.com/nasa/cumulus/blob/master/tf-modules/cumulus/variables.tf#L541">cumulus module</a> in <code>es_index_shards</code>.</p>
<blockquote>
<p>If you make changes to your Elasticsearch configuration you will need to <a href="../troubleshooting/reindex-elasticsearch">reindex</a> for those changes to take effect.</p>
</blockquote>
<h3><a class="anchor" aria-hidden="true" id="ec2-instances-and-autoscaling-groups"></a><a href="#ec2-instances-and-autoscaling-groups" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>EC2 instances and autoscaling groups</h3>
<p>EC2 instances are used for long-running operations (i.e. generating a reconciliation report) and long-running workflow tasks. Configuration for your ECS cluster is achieved via <a href="https://github.com/nasa/cumulus/blob/master/tf-modules/cumulus/variables.tf">Cumulus deployment variables</a>.</p>
<p>When configuring your ECS cluster consider:</p>
<ul>
<li>The <a href="https://aws.amazon.com/ec2/instance-types/">EC2 instance type</a> and <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/volume_constraints.html">EBS volume size</a> needed to accommodate your workloads. Configured as <code>ecs_cluster_instance_type</code> and <code>ecs_cluster_instance_docker_volume_size</code>.</li>
<li>The minimum and desired number of instances on hand to accommodate your workloads. Configured as <code>ecs_cluster_min_size</code> and <code>ecs_cluster_desired_size</code>.</li>
<li>The maximum number of instances you will need and are willing to pay for to accommodate your heaviest workloads. Configured as <code>ecs_cluster_max_size</code>.</li>
<li>Your autoscaling parameters: <code>ecs_cluster_scale_in_adjustment_percent</code>, <code>ecs_cluster_scale_out_adjustment_percent</code>, <code>ecs_cluster_scale_in_threshold_percent</code>, and <code>ecs_cluster_scale_out_threshold_percent</code>.</li>
</ul>
<hr>
<h2><a class="anchor" aria-hidden="true" id="footnotes"></a><a href="#footnotes" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Footnotes</h2>
<hr class="footnotes-sep">
<section class="footnotes">
<ol class="footnotes-list">
<li id="fn1"  class="footnote-item"><p>Run <code>terraform init</code> if:</p>
<ul>
<li>This is the first time deploying the module</li>
<li>You have added any additional child modules, including <a href="/cumulus/docs/v9.6.0/deployment/components#available-cumulus-components">Cumulus components</a></li>
<li>You have updated the <code>source</code> for any of the child modules</li>
</ul>
 <a href="#fnref1" class="footnote-backref">↩</a> <a href="#fnref1:1" class="footnote-backref">↩</a></li>
<li id="fn2"  class="footnote-item"><p>To add another redirect URIs to your application. On Earthdata home page, select &quot;My Applications&quot;. Scroll down to &quot;Application Administration&quot; and use the edit icon for your application. Then Manage -&gt; Redirect URIs. <a href="#fnref2" class="footnote-backref">↩</a></p>
</li>
<li id="fn3"  class="footnote-item"><p>The API root can be found a number of ways. The easiest is to note it in the output of the app deployment step. But you can also find it from the <code>AWS console -&gt; Amazon API Gateway -&gt; APIs -&gt; &lt;prefix&gt;-archive -&gt; Dashboard</code>, and reading the URL at the top after &quot;Invoke this API at&quot; <a href="#fnref3" class="footnote-backref">↩</a></p>
</li>
</ol>
</section>
</span></div></article></div><div class="docs-prevnext"><a class="docs-prev button" href="/cumulus/docs/v9.6.0/workflows/workflow-triggers"><span class="arrow-prev">← </span><span>Workflow Triggers</span></a><a class="docs-next button" href="/cumulus/docs/v9.6.0/deployment/create_bucket"><span>Creating an S3 Bucket</span><span class="arrow-next"> →</span></a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#overview">Overview</a></li><li><a href="#requirements">Requirements</a><ul class="toc-headings"><li><a href="#linuxmacos-software-requirements">Linux/MacOS software requirements</a></li><li><a href="#install-terraform">Install Terraform</a></li><li><a href="#credentials">Credentials</a></li><li><a href="#needed-git-repositories">Needed Git Repositories</a></li></ul></li><li><a href="#prepare-deployment-repository">Prepare deployment repository</a></li><li><a href="#prepare-aws-configuration">Prepare AWS configuration</a><ul class="toc-headings"><li><a href="#set-access-keys">Set Access Keys</a></li><li><a href="#create-s3-buckets">Create S3 Buckets</a></li><li><a href="#vpc-subnets-and-security-group">VPC, Subnets and Security Group</a></li><li><a href="#look-up-ecs-optimized-ami-deprecated">Look up ECS-optimized AMI (DEPRECATED)</a></li><li><a href="#set-up-ec2-key-pair-optional">Set up EC2 key pair (optional)</a></li></ul></li><li><a href="#configure-earthdata-application">Configure EarthData application</a></li><li><a href="#create-resources-for-terraform-state">Create resources for Terraform state</a><ul class="toc-headings"><li><a href="#create-the-state-bucket">Create the state bucket</a></li><li><a href="#create-the-locks-table">Create the locks table</a></li></ul></li><li><a href="#configure-the-postgresql-database">Configure the PostgreSQL database</a></li><li><a href="#deploy-the-cumulus-instance">Deploy the Cumulus instance</a><ul class="toc-headings"><li><a href="#troubleshooting">Troubleshooting</a></li><li><a href="#configure-and-deploy-the-data-persistence-tf-root-module">Configure and deploy the <code>data-persistence-tf</code> root module</a></li><li><a href="#deploy-the-cumulus-message-adapter-layer-deprecated">Deploy the Cumulus Message Adapter layer (DEPRECATED)</a></li><li><a href="#configure-and-deploy-the-cumulus-tf-root-module">Configure and deploy the <code>cumulus-tf</code> root module</a></li><li><a href="#update-earthdata-application">Update Earthdata Application</a></li></ul></li><li><a href="#deploy-cumulus-dashboard">Deploy Cumulus dashboard</a><ul class="toc-headings"><li><a href="#dashboard-requirements">Dashboard Requirements</a></li><li><a href="#prepare-aws">Prepare AWS</a></li><li><a href="#install-dashboard">Install dashboard</a></li><li><a href="#building-the-dashboard">Building the dashboard</a></li><li><a href="#dashboard-deployment">Dashboard deployment</a></li></ul></li><li><a href="#cumulus-instance-sizing">Cumulus Instance Sizing</a><ul class="toc-headings"><li><a href="#elasticsearch">Elasticsearch</a></li><li><a href="#ec2-instances-and-autoscaling-groups">EC2 instances and autoscaling groups</a></li></ul></li><li><a href="#footnotes">Footnotes</a></li></ul></nav></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script><script>
                document.addEventListener('keyup', function(e) {
                  if (e.target !== document.body) {
                    return;
                  }
                  // keyCode for '/' (slash)
                  if (e.keyCode === 191) {
                    const search = document.getElementById('search_input_react');
                    search && search.focus();
                  }
                });
              </script><script>
              var search = docsearch({
                
                apiKey: '1a3df8fed03e0ad718e663c44a94fe41',
                indexName: 'nasa_cumulus',
                inputSelector: '#search_input_react',
                algoliaOptions: {"facetFilters":["version:v9.6.0"]}
              });
            </script></body></html>